# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: Build Bundle

on:
  push:
    branches:
    - main
    - release-*
  
jobs:
  build-charms:
    name: Build and push bundles
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine Channel
        env:
            BRANCH: ${{ github.event.ref }}
        run: |
            BRANCH=${BRANCH#refs/heads/}  # strip off refs/heads/ if it exists
            if [[ "${BRANCH}" == "main" ]]; then
              echo "CHANNEL=latest/edge" >> "$GITHUB_ENV"
            elif [[ "${BRANCH}" =~ ^release-[0-9]+\.[0-9]+$ ]]; then
              echo "CHANNEL=${BRANCH:8}/edge" >> "$GITHUB_ENV"
            else
              echo "::error Failed to determine track/risk from branch ${BRANCH}"
              exit 1
            fi

      - name: Pack Bundle
        run: |
          sudo snap install charmcraft --classic --channel latest/stable
          pushd main
          charmcraft pack -v 
          echo "BUNDLE_FILE=$(ls ./*.zip)" >> $GITHUB_ENV
      
      - name: Upload bundle to edge
        uses: canonical/charming-actions/upload-charm@2.5.0-rc
        with:
          charm-path: main
          built-charm-path: ${{ env.BUNDLE_FILE }}
          channel: ${{ env.CHANNEL }}
          credentials: "${{ secrets.CHARMCRAFT_AUTH }}"
          github-token: "${{ secrets.GITHUB_TOKEN }}"
